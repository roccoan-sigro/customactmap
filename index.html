<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <meta name="googlebot" content="noindex">
    <title>Seleziona Area sulla Mappa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.min.css" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div id="map">
        <div id="mapImage">
            <img src="https://www.comune.roma.it/web-resources/static/img/logo_roma_header_white.png" alt="Logo Roma">
        </div>
    </div>
    <input type="range" id="radiusSlider" min="50" max="20000" step="50" value="50">
    <input type="number" id="radiusInput" min="50" max="20000" step="50" value="50"> metri
    <div id="address">Indirizzo: </div>
    <hr>
    <div>
        <input type="checkbox" id="consentCheckbox" checked>
        <label for="consentCheckbox">Includi solo i contatti che hanno prestato il consenso</label>
    </div>

    Record stimati: <div id="recordCount">...</div>

    <script src="js/require.js"></script>
    <script>
        require.config({
            paths: {
                "jquery": "js/jquery.min",
                "postmonger": "js/postmonger",
                "customActivity": "customActivity"
            }
        });

        require(['jquery', 'postmonger', 'customActivity'], function ($, Postmonger, customActivity) {
            const map = L.map('map', { attributionControl: false }).setView([41.9028, 12.4964], 13); // Centro su Roma

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            const geocoder = L.Control.geocoder({
                defaultMarkGeocode: false
            }).addTo(map);

            let marker;
            let circle;
            let debounceTimeout;

            function updateAddress(latlng) {
                if (!latlng) return;

                fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latlng.lat}&lon=${latlng.lng}&format=jsonv2`)
                    .then(response => response.json())
                    .then(data => {
                        const road = data.address.road || '';
                        const houseNumber = data.address.house_number || '';
                        const city = data.address.city || '';

                        let address = '';
                        if (road && houseNumber) {
                            address += `${road}, ${houseNumber}`;
                        } else if (road) {
                            address += `${road}`;
                        } else if (houseNumber) {
                            address += `${houseNumber}`;
                        }

                        if (city) {
                            address += `, ${city}`;
                        }

                        document.getElementById('address').innerText = `Indirizzo: ${address}`;
                        customActivity.updateAddressAndRadius(address, radiusSlider.value);
                    })
                    .catch(error => {
                        console.error('Errore durante il recupero dell\'indirizzo:', error);
                        document.getElementById('address').innerText = 'Indirizzo non disponibile';
                    });
            }

            function addMarkerAndCircle(latlng, radius) {
                if (!latlng) return;

                // Rimuove marcatore e cerchio esistenti
                if (marker) {
                    map.removeLayer(marker);
                    marker = null;
                }
                if (circle) {
                    map.removeLayer(circle);
                    circle = null;
                }

                // Aggiunge nuovo marcatore e cerchio
                marker = L.marker(latlng).addTo(map);
                circle = L.circle(latlng, {
                    radius: radius,
                    color: '#8e001c',
                    fillOpacity: 0.2
                }).addTo(map);

                const bounds = circle.getBounds();
                const selectedMinLatitude = bounds.getSouthWest().lat.toFixed(8);
                const selectedMaxLatitude = bounds.getNorthEast().lat.toFixed(8);
                const selectedMinLongitude = bounds.getSouthWest().lng.toFixed(8);
                const selectedMaxLongitude = bounds.getNorthEast().lng.toFixed(8);

                const latLngArray = [
                    [selectedMinLatitude, selectedMinLongitude],
                    [selectedMaxLatitude, selectedMaxLongitude]
                ];
                console.log('Coordinate rientranti nel cerchio:', latLngArray);

                customActivity.updateCoordinates({
                    minLatitude: selectedMinLatitude,
                    maxLatitude: selectedMaxLatitude,
                    minLongitude: selectedMinLongitude,
                    maxLongitude: selectedMaxLongitude
                });

                // Aggiorna l'indirizzo
                updateAddress(latlng);

                // Avvio del conteggio dei record dopo 3 secondi
                debounce(countRecords, 3000, selectedMinLatitude, selectedMaxLatitude, selectedMinLongitude, selectedMaxLongitude);
            }

            map.on('click', (e) => {
                addMarkerAndCircle(e.latlng, parseInt(radiusSlider.value));
            });

            geocoder.on('markgeocode', function (e) {
                map.fitBounds(e.geocode.bbox);
                addMarkerAndCircle(e.geocode.center, parseInt(radiusSlider.value));
            });

            const radiusSlider = document.getElementById('radiusSlider');
            const radiusInput = document.getElementById('radiusInput');
            const consentCheckbox = document.getElementById('consentCheckbox');

            radiusSlider.addEventListener('input', () => {
                const radius = parseInt(radiusSlider.value);
                radiusInput.value = radius;
                if (marker) {
                    addMarkerAndCircle(marker.getLatLng(), radius);
                }
            });

            radiusInput.addEventListener('input', () => {
                const radius = parseInt(radiusInput.value);
                radiusSlider.value = radius;
                if (marker) {
                    addMarkerAndCircle(marker.getLatLng(), radius);
                }
            });

            consentCheckbox.addEventListener('change', () => {
                if (marker && circle) {
                    const bounds = circle.getBounds();
                    const minLatitude = bounds.getSouthWest().lat.toFixed(8);
                    const maxLatitude = bounds.getNorthEast().lat.toFixed(8);
                    const minLongitude = bounds.getSouthWest().lng.toFixed(8);
                    const maxLongitude = bounds.getNorthEast().lng.toFixed(8);

                    console.log('Avvio del conteggio dei record per cambio stato della checkbox...');
                    debounce(countRecords, 3000, minLatitude, maxLatitude, minLongitude, maxLongitude);
                }
            });

            // Aggiorna il marker e il cerchio quando lo zoom cambia
            map.on('zoomend', () => {
                if (marker && circle) {
                    const latlng = marker.getLatLng();
                    if (latlng) {
                        const radius = parseInt(radiusSlider.value);
                        addMarkerAndCircle(latlng, radius);
                    }
                }
            });

            // Funzione debounce per ritardare l'esecuzione
            function debounce(func, wait, ...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func(...args), wait);
            }

            // Funzione per il conteggio dei record in base alle coordinate e al consenso
            function countRecords(minLatitude, maxLatitude, minLongitude, maxLongitude) {
                console.log('Avvio del conteggio dei record...');
                document.getElementById('recordCount').innerText = 'Record stimati: ...';

                Papa.parse('input.csv', {
                    download: true,
                    header: true,
                    complete: function(results) {
                        console.log('File CSV caricato con successo.');
                        const data = results.data;
                        const includeConsent = consentCheckbox.checked;

                        let count = 0;
                        for (let i = 0; i < data.length; i++) {
                            const record = data[i];
                            const latitude = parseFloat(record.Latitudine);
                            const longitude = parseFloat(record.Longitudine);
                            const consent = parseInt(record.Consenso, 10);

                            if (
                                latitude >= minLatitude && latitude <= maxLatitude &&
                                longitude >= minLongitude && longitude <= maxLongitude &&
                                (!includeConsent || consent === 1)
                            ) {
                                count++;
                            }
                        }

                        document.getElementById('recordCount').innerText = `Record stimati: ${count}`;
                        console.log(`Conteggio completato. Numero di record trovati: ${count}`);
                    },
                    error: function(error) {
                        document.getElementById('recordCount').innerText = 'Record stimati: X';
                        console.error('Errore durante il conteggio dei record:', error);
                    }
                });
            }

            // Ricarica le coordinate salvate, se presenti
            customActivity.initializeMap(function (latlng, radius) {
                if (latlng) {
                    addMarkerAndCircle(latlng, radius);
                }
            });
        });
    </script>
</body>
</html>
