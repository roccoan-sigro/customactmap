<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleziona Area sulla Mappa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');

        body {
            font-family: "Montserrat", sans-serif;
            font-optical-sizing: auto;
            font-weight: <weight>;
            font-style: normal;
        }
        
        #map {
            height: 400px;
            border: 4px solid #8e001c;
            margin-bottom: 5%;
        }

        /********** Range Input Styles **********/
        /*Range Reset*/
        input[type="range"] {
           -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 15rem;
        }
        
        /* Removes default focus */
        input[type="range"]:focus {
          outline: none;
        }
        
        /***** Chrome, Safari, Opera and Edge Chromium styles *****/
        /* slider track */
        input[type="range"]::-webkit-slider-runnable-track {
           background-color: grey;
           border-radius: 0.5rem;
           height: 0.5rem;  
        }
        
        /* slider thumb */
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none; /* Override default look */
           appearance: none;
           margin-top: -12px; /* Centers thumb on the track */
        
           /*custom styles*/
           background-color: #8e001c;
           height: 2rem;
           width: 1rem;
        }
        
        input[type="range"]:focus::-webkit-slider-thumb {   
          border: 1px solid grey;
          outline: 3px solid grey;
          outline-offset: 0.125rem; 
        }
        
        /******** Firefox styles ********/
        /* slider track */
        input[type="range"]::-moz-range-track {
           background-color: grey;
           border-radius: 0.5rem;
           height: 0.5rem;
        }
        
        /* slider thumb */
        input[type="range"]::-moz-range-thumb {
           border: none; /*Removes extra border that FF applies*/
           border-radius: 0; /*Removes default border-radius che FF applies*/
        
           /*custom styles*/
           background-color: #8e001c;
           height: 2rem;
           width: 1rem;
        }
        
        input[type="range"]:focus::-moz-range-thumb {
          border: 1px solid grey;
          outline: 3px solid grey;
          outline-offset: 0.125rem; 
        }

        #address {
            font-family: "Montserrat", sans-serif;
            font-size: 1rem;
            margin-top: 1rem;
        }

    </style>
</head>
<body>
    <div id="map"></div>
    <input type="range" id="radiusSlider" min="50" max="20000" step="50" value="50" >
    <input type="number" id="radiusInput" min="50" max="20000" step="50" value="50"> metri
    <div id="address"><span style="font-weight: bold;">Indirizzo:</span> </div>
    <script src="js/require.js"></script>
<script src="js/require.js"></script>
<script>
    require.config({
        paths: {
            "jquery": "js/jquery.min",
            "postmonger": "js/postmonger",
            "customActivity": "customActivity"
        }
    });

    require(['jquery', 'postmonger', 'customActivity'], function ($, Postmonger, customActivity) {
        const map = L.map('map', { attributionControl: false }).setView([41.9028, 12.4964], 13); // Centro su Roma

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false
        }).addTo(map);

        let marker;
        let circle;

        function updateAddress(latlng) {
            if (!latlng) return;
        
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latlng.lat}&lon=${latlng.lng}&format=jsonv2`)
                .then(response => response.json())
                .then(data => {
                    const road = data.address.road || '';
                    const houseNumber = data.address.house_number || '';
                    const city = data.address.city || '';
        
                    let address = '';
                    if (road && houseNumber) {
                        address += `${road}, ${houseNumber}`;
                    } else if (road) {
                        address += `${road}`;
                    } else if (houseNumber) {
                        address += `${houseNumber}`;
                    }
        
                    if (city) {
                        address += `, ${city}`;
                    }
        
                    document.getElementById('address').innerText = `Indirizzo: ${address}`;
                })
                .catch(error => {
                    console.error('Errore durante il recupero dell\'indirizzo:', error);
                    document.getElementById('address').innerText = 'Indirizzo non disponibile';
                });
        }



        function addMarkerAndCircle(latlng, radius) {
            if (!latlng) return;

            // Rimuove marcatore e cerchio esistenti
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
            if (circle) {
                map.removeLayer(circle);
                circle = null;
            }

            // Aggiunge nuovo marcatore e cerchio
            marker = L.marker(latlng).addTo(map);
            circle = L.circle(latlng, {
                radius: radius,
                color: '#8e001c',
                fillOpacity: 0.2
            }).addTo(map);

            const bounds = circle.getBounds();
            const selectedMinLatitude = bounds.getSouthWest().lat.toFixed(8);
            const selectedMaxLatitude = bounds.getNorthEast().lat.toFixed(8);
            const selectedMinLongitude = bounds.getSouthWest().lng.toFixed(8);
            const selectedMaxLongitude = bounds.getNorthEast().lng.toFixed(8);

            const latLngArray = [
                [selectedMinLatitude, selectedMinLongitude],
                [selectedMaxLatitude, selectedMaxLongitude]
            ];
            console.log('Coordinate rientranti nel cerchio:', latLngArray);

            customActivity.updateCoordinates({
                minLatitude: selectedMinLatitude,
                maxLatitude: selectedMaxLatitude,
                minLongitude: selectedMinLongitude,
                maxLongitude: selectedMaxLongitude
            });

            // Aggiorna l'indirizzo
            updateAddress(latlng);
        }

        map.on('click', (e) => {
            addMarkerAndCircle(e.latlng, parseInt(radiusSlider.value));
        });

        geocoder.on('markgeocode', function (e) {
            map.fitBounds(e.geocode.bbox);
            addMarkerAndCircle(e.geocode.center, parseInt(radiusSlider.value));
        });

        const radiusSlider = document.getElementById('radiusSlider');
        const radiusInput = document.getElementById('radiusInput');

        radiusSlider.addEventListener('input', () => {
            const radius = parseInt(radiusSlider.value);
            radiusInput.value = radius;
            if (marker) {
                addMarkerAndCircle(marker.getLatLng(), radius);
            }
        });

        radiusInput.addEventListener('input', () => {
            const radius = parseInt(radiusInput.value);
            radiusSlider.value = radius;
            if (marker) {
                addMarkerAndCircle(marker.getLatLng(), radius);
            }
        });

        // Aggiorna il marker e il cerchio quando lo zoom cambia
        map.on('zoomend', () => {
            if (marker && circle) {
                const latlng = marker.getLatLng();
                if (latlng) {
                    const radius = parseInt(radiusSlider.value);
                    addMarkerAndCircle(latlng, radius);
                }
            }
        });

        // Ricarica le coordinate salvate, se presenti
        customActivity.initializeMap(function (latlng, radius) {
            if (latlng) {
                addMarkerAndCircle(latlng, radius);
            }
        });
    });
</script>

</body>
</html>
